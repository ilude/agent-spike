# Deploy observability stack (Loki, Prometheus, Tempo, Grafana) to GPU server
# Syncs local files/observability/ to remote and runs docker compose up
#
# Usage: ansible-playbook playbooks/deploy-observability.yml

---
- name: Deploy Observability Stack to GPU server
  hosts: gpu_servers
  gather_facts: false
  vars:
    observability_dir: "/apps/observability"

  tasks:
    - name: Ensure observability directory exists
      ansible.builtin.file:
        path: "{{ observability_dir }}"
        state: directory
        mode: "0755"

    - name: Sync observability config files to remote
      ansible.builtin.copy:
        src: "../files/observability/"
        dest: "{{ observability_dir }}/"
        mode: "0644"
      register: sync_result

    - name: Copy root .env to remote (for GRAFANA_ADMIN_PASSWORD)
      ansible.builtin.copy:
        src: "/project/.env"
        dest: "{{ observability_dir }}/.env"
        mode: "0600"
      register: env_result

    - name: Pull latest observability images
      community.docker.docker_compose_v2:
        project_src: "{{ observability_dir }}"
        pull: always
        state: present
      register: pull_result

    - name: Start observability services
      community.docker.docker_compose_v2:
        project_src: "{{ observability_dir }}"
        state: present
      register: compose_result

    - name: Wait for Grafana to be ready
      ansible.builtin.uri:
        url: "http://localhost:3000/api/health"
        method: GET
        status_code: 200
      register: grafana_ready
      retries: 30
      delay: 2
      until: grafana_ready.status == 200
      ignore_errors: true

    - name: Wait for Loki to be ready
      ansible.builtin.uri:
        url: "http://localhost:3100/ready"
        method: GET
        status_code: 200
      register: loki_ready
      retries: 30
      delay: 2
      until: loki_ready.status == 200
      ignore_errors: true

    - name: Wait for Prometheus to be ready
      ansible.builtin.uri:
        url: "http://localhost:9090/-/healthy"
        method: GET
        status_code: 200
      register: prometheus_ready
      retries: 30
      delay: 2
      until: prometheus_ready.status == 200
      ignore_errors: true

    - name: Wait for Tempo to be ready
      ansible.builtin.uri:
        url: "http://localhost:3200/ready"
        method: GET
        status_code: 200
      register: tempo_ready
      retries: 30
      delay: 2
      until: tempo_ready.status == 200
      ignore_errors: true

    - name: Show running containers
      community.docker.docker_container_info:
        name: "{{ item }}"
      loop: "{{ compose_result.containers | default([]) | map(attribute='Name') | list }}"
      register: container_info
      ignore_errors: true

    - name: Deployment summary
      ansible.builtin.debug:
        msg: |
          Observability Stack Deployment complete!
          Target: {{ observability_dir }}
          Files synced: {{ sync_result.changed }}

          Services:
          - Grafana UI:   http://192.168.16.241:3000 (admin/{{ lookup('env', 'GRAFANA_ADMIN_PASSWORD') | default('admin', true) }})
          - Prometheus:   http://192.168.16.241:9090
          - Loki:         http://192.168.16.241:3100
          - Tempo:        http://192.168.16.241:3200
          - OTLP gRPC:    192.168.16.241:4317
          - OTLP HTTP:    192.168.16.241:4318

          Running containers:
          {{ compose_result.containers | default([]) | map(attribute='Name') | join('\n') }}

          Health checks:
          - Grafana: {{ 'OK' if grafana_ready.status | default(0) == 200 else 'FAILED' }}
          - Loki: {{ 'OK' if loki_ready.status | default(0) == 200 else 'FAILED' }}
          - Prometheus: {{ 'OK' if prometheus_ready.status | default(0) == 200 else 'FAILED' }}
          - Tempo: {{ 'OK' if tempo_ready.status | default(0) == 200 else 'FAILED' }}
