# Backup SurrealDB database to local machine
# Exports SQL dump for disaster recovery
# Run manually: make surrealdb-backup

---
- name: Backup SurrealDB to local machine
  hosts: gpu_servers
  gather_facts: false

  tasks:
    # Pre-flight validation
    - name: Check SurrealDB container is running
      ansible.builtin.shell: docker ps | grep surrealdb
      register: container_check
      failed_when: container_check.rc != 0
      changed_when: false

    - name: Generate timestamp for backup
      ansible.builtin.command: date +%Y-%m-%d_%H-%M-%S
      register: timestamp
      changed_when: false

    - name: Create backup directory on remote
      ansible.builtin.file:
        path: /tmp/surrealdb-backups
        state: directory
        mode: "0755"

    - name: Read SURREALDB_PASSWORD from remote .env file
      ansible.builtin.shell: grep '^SURREALDB_PASSWORD=' {{ compose_dir }}/.env | cut -d'=' -f2-
      register: surreal_password
      changed_when: false
      no_log: true

    # Perform backup (zero-downtime)
    - name: Export SurrealDB to SQL dump
      ansible.builtin.shell: |
        docker exec surrealdb /surreal export \
          --conn http://localhost:8000 \
          --user root \
          --pass "{{ surreal_password.stdout }}" \
          --ns data \
          --db graph_db \
          /tmp/backup-{{ timestamp.stdout }}.sql && \
        docker cp surrealdb:/tmp/backup-{{ timestamp.stdout }}.sql \
          /tmp/surrealdb-backups/backup-{{ timestamp.stdout }}.sql
      register: export_result
      failed_when: export_result.rc != 0
      no_log: true

    # Validate backup was created
    - name: Verify backup file exists and has content
      ansible.builtin.stat:
        path: "/tmp/surrealdb-backups/backup-{{ timestamp.stdout }}.sql"
      register: backup_stat
      failed_when: not backup_stat.stat.exists or backup_stat.stat.size < 1

    # Fetch to local machine
    - name: Fetch SQL dump to local machine
      ansible.builtin.fetch:
        src: "/tmp/surrealdb-backups/backup-{{ timestamp.stdout }}.sql"
        dest: "../backups/surrealdb/"
        flat: true

    # Cleanup remote temp file
    - name: Cleanup remote temp file
      ansible.builtin.file:
        path: "/tmp/surrealdb-backups/backup-{{ timestamp.stdout }}.sql"
        state: absent

    # Retention: Delete backups older than 7 days
    - name: Get list of local backups older than 7 days
      ansible.builtin.find:
        paths: "../backups/surrealdb/"
        patterns: "backup-*.sql"
        age: "7d"
        age_stamp: mtime
      register: old_backups
      delegate_to: localhost
      become: false

    - name: Delete old backups (keep last 7 days)
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: absent
      loop: "{{ old_backups.files }}"
      delegate_to: localhost
      become: false
      when: old_backups.files | length > 0

    # Report success
    - name: Backup complete
      ansible.builtin.debug:
        msg: |
          âœ“ SurrealDB backup complete!
          Backup saved to: infra/ansible/backups/surrealdb/backup-{{ timestamp.stdout }}.sql
          Size: {{ (backup_stat.stat.size / 1024 / 1024) | round(2) }} MB
          Retention: Keeping backups from last 7 days
