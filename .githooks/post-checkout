#!/usr/bin/env bash
# Post-checkout hook to automatically sync Brave history (incremental)

# Detect if terminal supports colors
if [ -t 1 ] && command -v tput >/dev/null 2>&1 && tput colors >/dev/null 2>&1; then
    # Terminal supports colors
    GREEN=$(printf '\033[0;32m')
    YELLOW=$(printf '\033[1;33m')
    NC=$(printf '\033[0m')  # No Color
else
    # No color support (e.g., in Claude Code)
    GREEN=""
    YELLOW=""
    NC=""
fi

# Only run on branch checkouts (not file checkouts)
if [ "$3" = "1" ]; then
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "  Brave History Sync (Automatic)"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo "${GREEN}Running incremental Brave history sync...${NC}"
    echo "  • Syncing new history since last update"
    echo "  • Consolidating across all machines"
    echo "  • Deduplicating records"
    echo ""

    # Run incremental sync automatically (no prompt)
    cd projects/data/brave_history 2>/dev/null || cd projects/brave_history 2>/dev/null || {
        echo "${YELLOW}⚠ Brave history directory not found. Skipping sync.${NC}"
        exit 0
    }

    # Use incremental sync for speed and safety
    if command -v uv >/dev/null 2>&1; then
        uv run python ../../../tools/scripts/brave_history/copy_brave_history.py --incremental --dest .
    else
        python ../../../tools/scripts/brave_history/copy_brave_history.py --incremental --dest .
    fi

    if [ $? -eq 0 ]; then
        echo ""
        echo "${GREEN}✓ Brave history synced successfully!${NC}"

        # Check if there are changes to commit
        if git diff --quiet brave_history.sqlite 2>/dev/null; then
            echo "  (No changes detected in consolidated history)"
        else
            echo "  Changes detected. To commit:"
            echo "    git add projects/data/brave_history/brave_history.sqlite"
            echo "    git commit -m 'chore: update consolidated Brave history'"
        fi
    else
        echo "${YELLOW}⚠ Sync encountered an issue. See errors above.${NC}"
        echo "  To run manually: cd projects/data/brave_history && python ../../../tools/scripts/brave_history/copy_brave_history.py --incremental --dest ."
    fi

    cd - >/dev/null 2>&1

    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
fi
