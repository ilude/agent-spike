#!/usr/bin/env bash
# Post-checkout hook to automatically sync Brave history (incremental)

# Detect if terminal supports colors
if [ -t 1 ] && command -v tput >/dev/null 2>&1 && tput colors >/dev/null 2>&1; then
    # Terminal supports colors
    GREEN=$(printf '\033[0;32m')
    YELLOW=$(printf '\033[1;33m')
    NC=$(printf '\033[0m')  # No Color
else
    # No color support (e.g., in Claude Code)
    GREEN=""
    YELLOW=""
    NC=""
fi

# Only run on branch checkouts (not file checkouts)
if [ "$3" = "1" ]; then
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "  Brave History Sync (Automatic)"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo "${GREEN}Running incremental Brave history sync...${NC}"
    echo "  • Syncing new history since last update"
    echo "  • Consolidating across all machines"
    echo "  • Deduplicating records"
    echo ""

    # Run incremental sync from repo root
    DATA_DIR="compose/data/queues/brave_history"
    SCRIPT="compose/cli/brave_history/copy_brave_history.py"

    if [ ! -d "$DATA_DIR" ]; then
        echo "${YELLOW}⚠ Brave history directory not found at $DATA_DIR. Skipping sync.${NC}"
        exit 0
    fi

    # Use incremental sync for speed and safety
    if command -v uv >/dev/null 2>&1; then
        uv run python "$SCRIPT" --incremental --dest "$DATA_DIR"
    else
        python "$SCRIPT" --incremental --dest "$DATA_DIR"
    fi

    if [ $? -eq 0 ]; then
        echo ""
        echo "${GREEN}✓ Brave history synced successfully!${NC}"

        # Check if there are changes to commit
        if git diff --quiet "$DATA_DIR/brave_history.sqlite" 2>/dev/null; then
            echo "  (No changes detected in consolidated history)"
        else
            echo "  Changes detected. To commit:"
            echo "    git add $DATA_DIR/brave_history.sqlite"
            echo "    git commit -m 'chore: update consolidated Brave history'"
        fi
    else
        echo "${YELLOW}⚠ Sync encountered an issue. See errors above.${NC}"
        echo "  To run manually: uv run python $SCRIPT --incremental --dest $DATA_DIR"
    fi

    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
fi
