#!/usr/bin/env bash
# Guardrail: prevent committing sensitive files unencrypted

set -euo pipefail

echo "[pre-commit] Verifying git-crypt encryption for sensitive paths..."

# Run git-crypt status and capture output
STATUS_OUTPUT=$(git crypt status || true)

# Fail if any files under compose/data/queues/brave_history are unencrypted
if echo "$STATUS_OUTPUT" | grep -E "^not encrypted:\s+compose/data/queues/brave_history/" >/dev/null 2>&1; then
  echo "\nError: Some files under compose/data/queues/brave_history are not encrypted by git-crypt." >&2
  echo "Please ensure .gitattributes includes the correct patterns and rerun:" >&2
  echo "  git crypt status -f" >&2
  echo "Then commit again." >&2
  echo "\nDetails:" >&2
  echo "$STATUS_OUTPUT" | grep -E "^not encrypted:\s+compose/data/queues/brave_history/" >&2
  exit 1
fi

# Fail if any files are marked encrypted but were previously staged/committed unencrypted
if echo "$STATUS_OUTPUT" | grep -F "*** WARNING: staged/committed version is NOT ENCRYPTED! ***" >/dev/null 2>&1; then
  echo "\nError: Index contains files newly marked for encryption but with prior unencrypted versions." >&2
  echo "Run: git crypt status -f  to stage encrypted versions, then commit." >&2
  echo "\nDetails:" >&2
  echo "$STATUS_OUTPUT" | grep -F "*** WARNING: staged/committed version is NOT ENCRYPTED! ***" -n -B1 >&2
  exit 1
fi

echo "[pre-commit] git-crypt checks passed."
exit 0
