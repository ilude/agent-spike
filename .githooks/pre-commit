#!/usr/bin/env bash
# Optimized pre-commit: Only check files being committed (not all 1,633 encrypted files)

set -euo pipefail

echo "[pre-commit] Checking staged files for encryption..."

# Get list of staged files under sensitive paths
STAGED_SENSITIVE=$(git diff --cached --name-only --diff-filter=ACM | \
  grep -E '^(\.env|secrets/|compose/data/browser_history/|compose/data/queues/brave_history/)' || true)

if [ -z "$STAGED_SENSITIVE" ]; then
  echo "[pre-commit] No sensitive files staged. Skipping encryption check."
  exit 0
fi

# Run git-crypt status only on staged sensitive files
echo "$STAGED_SENSITIVE" | while read -r file; do
  if [ ! -f "$file" ]; then
    continue  # Skip deleted files
  fi

  STATUS=$(git crypt status -f "$file" 2>&1 || true)

  if echo "$STATUS" | grep -q "not encrypted"; then
    echo "Error: Staged file '$file' is not encrypted by git-crypt!" >&2
    echo "Please ensure .gitattributes includes this path pattern." >&2
    exit 1
  fi

  if echo "$STATUS" | grep -q "WARNING.*NOT ENCRYPTED"; then
    echo "Error: Staged file '$file' was previously committed unencrypted!" >&2
    echo "Run: git crypt status -f  to re-encrypt, then commit again." >&2
    exit 1
  fi
done

echo "[pre-commit] Encryption checks passed ($(echo "$STAGED_SENSITIVE" | wc -l) files verified)."
exit 0
